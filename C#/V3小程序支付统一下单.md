> 签名：https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml
>
> 签名生成：https://wechatpay-api.gitbook.io/wechatpay-api-v3/qian-ming-zhi-nan-1/qian-ming-sheng-cheng
>
> 统一下单接口：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_2_1.shtml
>
> 如何查看证书序列号：https://wechatpay-api.gitbook.io/wechatpay-api-v3/chang-jian-wen-ti/zheng-shu-xiang-guan#ru-he-cha-kan-zheng-shu-xu-lie-hao
>
> 私钥和证书：https://wechatpay-api.gitbook.io/wechatpay-api-v3/ren-zheng/zheng-shu#sheng-ming-suo-shi-yong-de-zheng-shu
>
>  

```C#
计算签名的示例代码如下。
    
    using System;
using System.IO;
using System.Net.Http;
using System.Security.Cryptography;
using System.Threading;
using System.Threading.Tasks;

namespace HttpHandlerDemo
{
    // 使用方法
    // HttpClient client = new HttpClient(new HttpHandler("{商户号}", "{商户证书序列号}"));
    // ...
    // var response = client.GetAsync("https://api.mch.weixin.qq.com/v3/certificates");
    public class HttpHandler : DelegatingHandler
    {
        private readonly string merchantId;
        private readonly string serialNo;

        public HttpHandler(string merchantId, string merchantSerialNo)
        {
            InnerHandler = new HttpClientHandler();

            this.merchantId = merchantId;
            this.serialNo = merchantSerialNo;
        }

        protected async override Task SendAsync(
            HttpRequestMessage request,
            CancellationToken cancellationToken)
        {
            var auth = await BuildAuthAsync(request);
            string value = $"WECHATPAY2-SHA256-RSA2048 {auth}";
            request.Headers.Add("Authorization", value);

            return await base.SendAsync(request, cancellationToken);
        }

        protected async Task BuildAuthAsync(HttpRequestMessage request)
        {
            string method = request.Method.ToString();
            string body = "";
            if (method == "POST" || method == "PUT" || method == "PATCH")
            {
                var content = request.Content;
                body = await content.ReadAsStringAsync();
            }

            string uri = request.RequestUri.PathAndQuery;
            var timestamp = DateTimeOffset.Now.ToUnixTimeSeconds();
            string nonce = Path.GetRandomFileName();

            string message = $"{method}\n{uri}\n{timestamp}\n{nonce}\n{body}\n";
            string signature = Sign(message);
            return $"mchid=\"{merchantId}\",nonce_str=\"{nonce}\",timestamp=\"{timestamp}\",serial_no=\"{serialNo}\",signature=\"{signature}\"";
        }

        protected string Sign(string message)
        {
            // NOTE： 私钥不包括私钥文件起始的-----BEGIN PRIVATE KEY-----
            //        亦不包括结尾的-----END PRIVATE KEY-----
            string privateKey = "{你的私钥}";
            byte[] keyData = Convert.FromBase64String(privateKey);
            using (CngKey cngKey = CngKey.Import(keyData, CngKeyBlobFormat.Pkcs8PrivateBlob))
            using (RSACng rsa = new RSACng(cngKey))
            {
                byte[] data = System.Text.Encoding.UTF8.GetBytes(message);
                return Convert.ToBase64String(rsa.SignData(data, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1));
            }
        }
    }
}
```

```C#

  /// 生成订单号
        /// </summary>
        /// <returns></returns>
        private static string getRandomTime()
        {
            Random rd = new Random();//用于生成随机数
            string DateStr = DateTime.Now.ToString("yyyyMMddHHmmssMM");//日期
            string str = DateStr + rd.Next(10000).ToString().PadLeft(4, '0');//带日期的随机数
            return str;
        }
        /// <summary>
        /// 生成随机串    
        /// </summary>
        /// <param name="length">字符串长度</param>
        /// <returns></returns>
        private static string GetRandomString(int length)
        {
            const string key = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            if (length < 1)
                return string.Empty;

            Random rnd = new Random();
            byte[] buffer = new byte[8];

            ulong bit = 31;
            ulong result = 0;
            int index = 0;
            StringBuilder sb = new StringBuilder((length / 5 + 1) * 5);

            while (sb.Length < length)
            {
                rnd.NextBytes(buffer);

                buffer[5] = buffer[6] = buffer[7] = 0x00;
                result = BitConverter.ToUInt64(buffer, 0);

                while (result > 0 && sb.Length < length)
                {
                    index = (int)(bit & result);
                    sb.Append(key[index]);
                    result = result >> 5;
                }
            }
            return sb.ToString();
        }

        public class Wxamount{
         public  int    total  { get; set; }
        }
        public class Wxpayer {
            public string openid { get; set; }
        }
        public class WxbodyModel {
            public string mchid { get; set; }
            public Object amount { get; set; }
            public Object payer { get; set; }
            public string out_trade_no { get; set; }
            public string notify_url { get; set; }
            public string attach { get; set; }
            public string description { get; set; }
            public string appid { get; set; }
           

        }
        public static   async Task<string> postprepay(string openid , string description,int total,string  attach) {
            var formData = new WxbodyModel {
            mchid= mch_id,
            out_trade_no= getRandomTime(),
            notify_url= notifyurl,
            attach= attach,
            description= description,
            appid=appid,
            amount =new Wxamount { 
               total= total
            },
            payer=new Wxpayer {
               openid=openid
            },

            };
           
           HttpClient client = new HttpClient(new HttpHandler("{商户号}", "{商户证书序列号}"));
            var bodyJson = new StringContent(formData.ToJson(), Encoding.UTF8, "application/json");
            var response = await client.PostAsync(url, bodyJson);
            // 读取统一下单之后的返回结果，这样读取出来的直接就是结果，或者错误原因，大家一定要这么搞啊！！！多么痛的领悟，会有具体的错误信息的。
            var respStr = await response.Content.ReadAsStringAsync();//这里面就包含prepay_id了


            JObject jo = (JObject)JsonConvert.DeserializeObject(respStr);
            string timeStamp = getTime().ToString();
            string nonceStr= GetRandomString(30);
            string zone = jo["prepay_id"].ToString();
            string package= "prepay_id="+ zone;
            //第二次签名
            string paySign = HttpHandlerH5.Sign(appid+"\n"+ timeStamp+"\n"+ nonceStr + "\n"+ package+"\n");
          
            wx w = new wx();
            w.result = "Success";
            w.errmsg = "统一下单成功";
            w.timeStamp = timeStamp;
            w.nonce_str = nonceStr;
            w.prepay_id = package;
            w.sign = paySign; ;
            w.signType = "RSA";
            w.trade_type = "JSAPI";
            return JsonConvert.SerializeObject(w);


        }
        /// <summary>
        /// 获取时间戳
        /// </summary>
        /// <returns></returns>
        private static long getTime()
        {
            TimeSpan ts = DateTime.Now - new DateTime(1970, 1, 1, 0, 0, 0, 0);
            return Convert.ToInt64(ts.TotalSeconds);

        }
        public class wx
        {
            /// <summary>
            /// 返回结果【Success/Error】
            /// </summary>
            public string result { get; set; }
            /// <summary>
            /// 描述
            /// </summary>
            public string errmsg { get; set; }

            /// <summary>
            /// 时间戳
            /// </summary>
            public string timeStamp { get; set; }
            /// <summary>
            /// 随机数
            /// </summary>
            public string nonce_str { get; set; }
            /// <summary>
            /// 同一下单接口的prepay_id参数
            /// </summary>
            public string prepay_id { get; set; }
            /// <summary>
            /// 第二次签名
            /// </summary>
            public string sign { get; set; }
            /// <summary>
            /// 签名方式
            /// </summary>
            public string signType { get; set; }
            /// <summary>
            /// 交易类型
            /// </summary>
            public string trade_type { get; set; }
            /// <summary>
            /// 商户订单号
            /// </summary>

            public string out_trade_no { get; set; }

        }
```



